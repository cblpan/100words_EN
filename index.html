import React, { useState, useEffect, useRef } from 'react';
import { BookOpen, Edit3, Calendar as CalIcon, CheckCircle, Play, AlertCircle, TrendingUp, ChevronLeft, ChevronRight, Flame, Shuffle, Eye, EyeOff, Clock, Brain, BatteryCharging, Trash2, UploadCloud, FileText, Download, X, Settings, Search, Book, Github, Loader2 } from 'lucide-react';
import { initializeApp } from "firebase/app";
import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
import { getFirestore, collection, doc, query, orderBy, serverTimestamp, writeBatch, onSnapshot, getDocs } from "firebase/firestore";

// --- Firebase Init ---
let auth, db, appId;
try {
  const firebaseConfig = JSON.parse(__firebase_config);
  const app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  db = getFirestore(app);
  appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
} catch (e) { console.error(e); }

// â˜…â˜…â˜… ì—¬ê¸°ì— 1ë‹¨ê³„ì—ì„œ ë³µì‚¬í•œ Raw ì£¼ì†Œë¥¼ ë„£ìœ¼ì„¸ìš” â˜…â˜…â˜…
const GITHUB_CSV_URL = "raw.githubusercontent.com/cblpan/100words_EN/refs/heads/main/CEFR_10000_EN.csv"; 
// (ìœ„ ì£¼ì†ŒëŠ” ì˜ˆì‹œì…ë‹ˆë‹¤. ë³¸ì¸ì˜ raw ì£¼ì†Œë¡œ ë°”ê¾¸ëŠ” ê²Œ ê°€ì¥ ì¢‹ìŠµë‹ˆë‹¤!)

// --- Logic Helpers ---
const getSimilarity = (s1, s2) => {
  if (!s1 || !s2) return 0;
  const l = s1.length > s2.length ? s1 : s2;
  const s = s1.length > s2.length ? s2 : s1;
  if (l.length === 0) return 1.0;
  const costs = new Array();
  for (let i = 0; i <= l.length; i++) {
    let lastValue = i;
    for (let j = 0; j <= s.length; j++) {
      if (i === 0) costs[j] = j;
      else if (j > 0) {
        let newValue = costs[j - 1];
        if (l.charAt(i - 1) !== s.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
        costs[j - 1] = lastValue;
        lastValue = newValue;
      }
    }
    if (i > 0) costs[s.length] = lastValue;
  }
  return (l.length - costs[s.length]) / l.length;
};

const calculateNextReview = (currentInterval, isCorrect) => {
  if (!isCorrect) return 0; 
  if (currentInterval === 0) return 1;
  if (currentInterval === 1) return 3;
  if (currentInterval === 3) return 7;
  if (currentInterval === 7) return 14;
  if (currentInterval === 14) return 30;
  return Math.floor(currentInterval * 2);
};

const parseCSV = (text) => {
  const lines = text.replace(/\r\n/g, '\n').split('\n').filter(l => l.trim());
  if (lines.length < 2) return [];

  const parseLine = (line) => {
      const res = [];
      let start = 0, inQuotes = false;
      for (let i = 0; i < line.length; i++) {
          if (line[i] === '"') { inQuotes = !inQuotes; }
          else if (line[i] === ',' && !inQuotes) {
              res.push(line.substring(start, i));
              start = i + 1;
          }
      }
      res.push(line.substring(start));
      return res.map(c => c.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
  };

  // Detect headers dynamically
  const headers = parseLine(lines[0]).map(h => h.toLowerCase());
  let termIdx = -1, levelIdx = -1, defIdx = -1;
  
  headers.forEach((h, i) => {
      if(h.includes('word') || h.includes('term') || h.includes('headword')) termIdx = i;
      if(h.includes('level') || h.includes('cefr')) levelIdx = i;
      if(h.includes('def') || h.includes('mean')) defIdx = i;
  });

  // Fallbacks
  if (termIdx === -1) termIdx = 0;
  if (levelIdx === -1) levelIdx = 1;

  return lines.slice(1).map(line => {
      const cols = parseLine(line);
      if(cols.length < 2) return null;
      return { 
          term: cols[termIdx] || "Unknown", 
          level: cols[levelIdx] || "??", 
          definition: (defIdx > -1 && cols[defIdx]) ? cols[defIdx] : "" // Empty def will trigger auto-fetch
      };
  }).filter(Boolean);
};

const SimpleLineChart = ({ data, color = "#4f46e5" }) => {
  if (!data || data.length === 0) return <div className="h-40 flex items-center justify-center text-slate-400 text-xs bg-slate-50 rounded-xl border border-slate-100 w-full">ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤</div>;
  const width = 300, height = 150;
  const pX = 30, pY = 20;
  const cH = height - pY * 2;
  const cW = width - pX * 2;
  const maxVal = 100;

  const points = data.map((d, i) => {
    const x = pX + (i * cW) / (data.length - 1 || 1);
    const y = height - pY - ((d.value / maxVal) * cH);
    return `${x},${y}`;
  }).join(' ');

  return (
    <div className="w-full h-40 overflow-hidden">
      <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full">
        <line x1={pX} y1={height - pY} x2={width - pX} y2={height - pY} stroke="#e2e8f0" strokeWidth="1" />
        <polyline fill="none" stroke={color} strokeWidth="2" points={points} />
        {data.map((d, i) => {
            const x = pX + (i * cW) / (data.length - 1 || 1);
            const val = isNaN(d.value) ? 0 : Math.round(d.value);
            const y = height - pY - ((val / maxVal) * cH);
            return (
                <g key={i}>
                    <circle cx={x} cy={y} r="3" fill="white" stroke={color} strokeWidth="2" />
                    <text x={x} y={height - 5} textAnchor="middle" fontSize="10" fill="#94a3b8">{d.label}</text>
                    {(i === data.length - 1 || data.length < 5) && <text x={x} y={y - 8} textAnchor="middle" fontSize="10" fill="#64748b" fontWeight="bold">{val}%</text>}
                </g>
            );
        })}
      </svg>
    </div>
  );
};

export default function App() {
  const [user, setUser] = useState(null);
  
  // Data
  const [words, setWords] = useState([]);
  const [dueWords, setDueWords] = useState([]);
  const [wrongWords, setWrongWords] = useState([]);
  const [historyData, setHistoryData] = useState({});
  const [streak, setStreak] = useState(0);
  
  // UI State
  const [mode, setMode] = useState('loading');
  const [currentDate, setCurrentDate] = useState(new Date());
  const [chartTab, setChartTab] = useState('week'); 
  
  // Test State
  const [hideTerm, setHideTerm] = useState(false);
  const [hideDef, setHideDef] = useState(false);
  const [currentTestWords, setCurrentTestWords] = useState([]);
  const [isRetest, setIsRetest] = useState(false);
  const [timeLeft, setTimeLeft] = useState(600);
  const [isActive, setIsActive] = useState(false);
  const [userAnswers, setUserAnswers] = useState({});
  const [score, setScore] = useState(0);
  const [gradedResults, setGradedResults] = useState({});
  
  const [searchTerm, setSearchTerm] = useState('');
  const [searchResult, setSearchResult] = useState(null);

  const fileInputRef = useRef(null);
  const [uploadStatus, setUploadStatus] = useState('');
  const [isUploading, setIsUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState(0);
  const initialLoadComplete = useRef(false);

  useEffect(() => {
    if (!auth) return;
    const init = async () => { try { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await auth.signInWithCustomToken(__initial_auth_token); else await signInAnonymously(auth); } catch (e) { await signInAnonymously(auth); } };
    init();
    return onAuthStateChanged(auth, setUser);
  }, []);

  useEffect(() => {
    if (!user || !db) return;
    const unsubWords = onSnapshot(query(collection(db, 'artifacts', appId, 'users', user.uid, 'vocabulary')), (snap) => {
      const all = snap.docs.map(d => ({id: d.id, ...d.data()}));
      setWords(all);
      const now = Date.now();
      const due = all.filter(w => {
          if (!w.nextReviewDate) return true; 
          const nextTime = w.nextReviewDate.toMillis ? w.nextReviewDate.toMillis() : (w.nextReviewDate.getTime ? w.nextReviewDate.getTime() : 0);
          return nextTime <= now;
      });
      setDueWords(due);
      
      if (!initialLoadComplete.current) {
          initialLoadComplete.current = true;
          setMode('dashboard');
      }
    });
    const unsubHistory = onSnapshot(query(collection(db, 'artifacts', appId, 'users', user.uid, 'history')), (snap) => {
      const h = {}; snap.forEach(d => h[d.id] = d.data()); setHistoryData(h);
      let s = 0; const t = new Date(); for(let i=0; i<365; i++) { const d = new Date(); d.setDate(t.getDate()-i); if(h[d.toISOString().split('T')[0]]?.completed) s++; else if(i>0) break; } setStreak(s);
    });
    const unsubWrong = onSnapshot(query(collection(db, 'artifacts', appId, 'users', user.uid, 'wrong_answers')), (snap) => {
      setWrongWords(snap.docs.map(d => ({id: d.id, ...d.data()})));
    });
    return () => { unsubWords(); unsubHistory(); unsubWrong(); };
  }, [user]);

  // Auto Fetch Definition
  useEffect(() => {
    if (mode === 'study' && currentTestWords.length > 0) {
        const fetchMissing = async () => {
            const newWords = [...currentTestWords];
            let hasUpdates = false;
            for (let i = 0; i < newWords.length; i++) {
                if (!newWords[i].definition) {
                    try {
                        const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${newWords[i].term}`);
                        if (res.ok) {
                            const data = await res.json();
                            if (data[0]?.meanings[0]?.definitions[0]?.definition) {
                                newWords[i].definition = data[0].meanings[0].definitions[0].definition;
                                hasUpdates = true;
                            }
                        }
                    } catch(e) {}
                }
            }
            if (hasUpdates) setCurrentTestWords(newWords);
        };
        fetchMissing();
    }
  }, [mode, currentTestWords]);

  useEffect(() => {
    let interval = null;
    if (isActive && timeLeft > 0) interval = setInterval(() => setTimeLeft(t => t-1), 1000);
    else if (timeLeft === 0) { clearInterval(interval); handleTimeout(); }
    return () => clearInterval(interval);
  }, [isActive, timeLeft]);

  const handleTimeout = () => {
    setIsActive(false);
    alert(mode === 'study' ? "ì•”ê¸° ì¢…ë£Œ! ì‹œí—˜ ì‹œì‘" : "ì‹œí—˜ ì¢…ë£Œ! ì œì¶œ");
    if (mode === 'study') startTest(); else submitTest();
  };

  const clearData = async () => {
      if(!user || !confirm("ì •ë§ ëª¨ë“  ë‹¨ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      setIsUploading(true);
      setUploadProgress(50);
      const snap = await getDocs(collection(db, 'artifacts', appId, 'users', user.uid, 'vocabulary'));
      const batch = writeBatch(db);
      snap.forEach(d => batch.delete(d.ref));
      await batch.commit();
      setUploadProgress(100);
      setTimeout(()=> { setIsUploading(false); setUploadProgress(0); }, 1000);
  };

  // --- GitHub Seed Logic ---
  const handleGitHubSeed = async () => {
      if(!user) return;
      if(!confirm("GitHubì—ì„œ ë°ì´í„°ë¥¼ ë°›ì•„ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ? ê¸°ì¡´ ë°ì´í„° ìœ„ì— ì¶”ê°€ë©ë‹ˆë‹¤.")) return;
      
      setIsUploading(true);
      setUploadStatus('ë‹¤ìš´ë¡œë“œ ì¤‘...');
      setUploadProgress(10);

      try {
          // 1. Fetch CSV from GitHub Raw URL
          const response = await fetch(GITHUB_CSV_URL);
          if (!response.ok) throw new Error("GitHub ì—°ê²° ì‹¤íŒ¨. URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
          const csvText = await response.text();
          
          setUploadStatus('ë¶„ì„ ì¤‘...');
          setUploadProgress(30);

          // 2. Parse CSV
          const data = parseCSV(csvText);
          if (data.length === 0) throw new Error("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

          // 3. Batch Write to Firebase
          setUploadStatus(`${data.length}ê°œ ì €ì¥ ì¤‘...`);
          const BATCH_SIZE = 500;
          const batches = [];
          for (let i = 0; i < data.length; i += BATCH_SIZE) {
              batches.push(data.slice(i, i + BATCH_SIZE));
          }

          let completed = 0;
          for (const chunk of batches) {
              const batch = writeBatch(db);
              chunk.forEach(w => {
                  const ref = doc(collection(db, 'artifacts', appId, 'users', user.uid, 'vocabulary'));
                  batch.set(ref, { 
                      ...w, 
                      createdAt: serverTimestamp(), 
                      correctCount: 0, 
                      totalAttempts: 0, 
                      interval: 0, 
                      nextReviewDate: new Date() // Immediately available
                  });
              });
              await batch.commit();
              completed++;
              setUploadProgress(30 + Math.round((completed / batches.length) * 70));
          }

          alert(`ì„±ê³µ! ${data.length}ê°œì˜ ë‹¨ì–´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
      } catch (error) {
          console.error(error);
          alert(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
      } finally {
          setIsUploading(false);
          setUploadStatus('');
          setUploadProgress(0);
      }
  };

  const handleFileUpload = async (e) => {
      const file = e.target.files[0];
      if (!file || !user) return;
      
      setIsUploading(true);
      setUploadProgress(5);
      setUploadStatus('íŒŒì¼ ì½ëŠ” ì¤‘...');

      const reader = new FileReader();
      reader.onload = async (evt) => {
          try {
              const data = parseCSV(evt.target.result);
              if (data.length === 0) throw new Error("ë°ì´í„° ì—†ìŒ");
              
              setUploadStatus(`${data.length}ê°œ ì €ì¥ ì¤‘...`);
              const BATCH_SIZE = 500;
              const batches = [];
              for (let i = 0; i < data.length; i += BATCH_SIZE) {
                  batches.push(data.slice(i, i + BATCH_SIZE));
              }

              let completed = 0;
              for (const chunk of batches) {
                  const batch = writeBatch(db);
                  chunk.forEach(w => {
                      const ref = doc(collection(db, 'artifacts', appId, 'users', user.uid, 'vocabulary'));
                      batch.set(ref, { ...w, createdAt: serverTimestamp(), correctCount: 0, totalAttempts: 0, interval: 0, nextReviewDate: new Date() });
                  });
                  await batch.commit();
                  completed++;
                  setUploadProgress(Math.round((completed / batches.length) * 100));
              }
          } catch (err) { 
              console.error(err);
              alert("íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          } finally {
              setIsUploading(false);
              setUploadStatus('');
              setUploadProgress(0);
          }
      };
      reader.readAsText(file);
  };

  const startRoutine = () => {
    let sessionWords = dueWords;
    if (sessionWords.length === 0) {
        if (words.length === 0) return alert("ë‹¨ì–´ì¥ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
        if (!confirm("ì˜¤ëŠ˜ ë³µìŠµ ì™„ë£Œ! ëœë¤ 20ê°œë¡œ ë” ê³µë¶€í• ê¹Œìš”?")) return;
        sessionWords = [...words];
    }
    const selected = sessionWords.sort(() => Math.random() - 0.5).slice(0, 50);
    setCurrentTestWords(selected);
    setIsRetest(false); setMode('study'); setTimeLeft(600); setIsActive(true);
    setHideTerm(false); setHideDef(false);
  };

  const startWrongRetest = () => {
    const s = [...wrongWords].sort(() => Math.random() - 0.5);
    setCurrentTestWords(s); setIsRetest(true); setMode('test');
    setTimeLeft(Math.min(600, s.length * 15 + 30)); setIsActive(true); setUserAnswers({});
  };

  const startTest = () => { setMode('test'); if(!isRetest) setTimeLeft(600); setIsActive(true); setUserAnswers({}); window.scrollTo(0,0); };

  const checkAnswer = (ans, def) => {
    try {
        if (!ans || !def) return { isCorrect: false };
        const cA = String(ans).trim().replace(/\s+/g, '').toLowerCase();
        const cDs = String(def).split(',').map(s => s.trim().replace(/\s+/g, '').toLowerCase());
        if (cDs.includes(cA)) return { isCorrect: true, type: 'exact' };
        for (const d of cDs) {
           if (d.length < 2) continue;
           if (getSimilarity(cA, d) >= 0.6 || (d.length>=2 && d.includes(cA))) return { isCorrect: true, type: 'similar' };
        }
        return { isCorrect: false };
    } catch (error) { return { isCorrect: false }; }
  };

  const submitTest = async (e) => {
    if (e) { e.preventDefault(); e.stopPropagation(); }
    setIsActive(false);
    let c = 0; const todayStr = new Date().toISOString().split('T')[0];
    const newG = {};
    
    currentTestWords.forEach(w => {
      const ans = userAnswers[w.id] || '';
      const res = checkAnswer(ans, w.definition);
      newG[w.id] = res;
      if (res.isCorrect) c++;
    });

    setScore(c); 
    setGradedResults(newG); 
    setMode('result'); 

    try {
        const batch = writeBatch(db);
        currentTestWords.forEach(w => {
            const res = newG[w.id] || { isCorrect: false };
            const wrongRef = doc(db, 'artifacts', appId, 'users', user.uid, 'wrong_answers', w.id);
            const ans = userAnswers[w.id] || '';

            if (res.isCorrect) {
                if (isRetest) batch.delete(wrongRef);
            } else {
                batch.set(wrongRef, { term: w.term, definition: w.definition, level: w.level||'', lastMissed: todayStr, userWrongAnswer: ans });
            }

            if (!isRetest) {
                const wRef = doc(db, 'artifacts', appId, 'users', user.uid, 'vocabulary', w.id);
                const nInt = calculateNextReview(w.interval||0, res.isCorrect);
                const nDate = new Date(); nDate.setDate(nDate.getDate()+nInt);
                batch.update(wRef, { correctCount: (w.correctCount||0)+(res.isCorrect?1:0), totalAttempts: (w.totalAttempts||0)+1, interval: nInt, nextReviewDate: nDate });
            }
        });

        if (!isRetest) {
            const hRef = doc(db, 'artifacts', appId, 'users', user.uid, 'history', todayStr);
            batch.set(hRef, { score: c, total: currentTestWords.length, percent: Math.round((c/currentTestWords.length)*100), timestamp: serverTimestamp(), completed: true });
        }
        await batch.commit();
    } catch (err) { console.error("Save failed", err); }
  };

  const handleSearch = () => {
      const found = words.find(w => w.term.toLowerCase() === searchTerm.toLowerCase());
      if (found) { setSearchResult(found); } 
      else {
          fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${searchTerm}`)
            .then(res => res.json())
            .then(data => {
                if(data[0]) setSearchResult({ term: searchTerm, definition: data[0].meanings[0].definitions[0].definition, level: 'Web' });
                else setSearchResult({ term: searchTerm, definition: "ì‚¬ì „ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", level: '?' });
            })
            .catch(() => setSearchResult({ term: searchTerm, definition: "ì˜¤ë¥˜ ë°œìƒ", level: '?' }));
      }
  };

  const LevelBadge = ({level}) => <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded border block w-fit mt-1 ${level==='C2'?'bg-red-50 text-red-600 border-red-100':level==='C1'?'bg-orange-50 text-orange-600 border-orange-100':'bg-blue-50 text-blue-600 border-blue-100'}`}>{level||'?'}</span>;
  const StatBadge = ({correct, total}) => total ? <span className={`text-[10px] font-mono px-1 rounded border block w-fit mt-1 ${correct/total>=0.8?'text-green-600 border-green-100 bg-green-50':'text-red-500 border-red-100 bg-red-50'}`}>{Math.round((correct/total)*100)}%</span> : <span className="text-[10px] bg-slate-100 text-slate-400 px-1 rounded block w-fit mt-1 border border-slate-200">New</span>;

  // Views
  const DashboardView = () => {
    const today = new Date();
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startDayOfWeek = firstDay.getDay(); 
    const days = [];
    for(let i=0; i<startDayOfWeek; i++) days.push(null); for(let i=1; i<=daysInMonth; i++) days.push(i);

    const prevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
    const nextMonth = () => setCurrentDate(new Date(year, month + 1, 1));

    const showRefillAlert = words.length < 100 && words.length > 0;

    const getChartData = () => {
        const data = [];
        const dateKeys = Object.keys(historyData).sort();

        if (chartTab === 'week') {
            const t = new Date();
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(t.getDate() - i);
                const k = d.toISOString().split('T')[0];
                data.push({ label: `${d.getMonth()+1}/${d.getDate()}`, value: historyData[k]?.percent || 0 });
            }
        } else if (chartTab === 'month') {
            const months = {};
            dateKeys.forEach(k => {
                const m = k.substring(0, 7); // YYYY-MM
                if(!months[m]) months[m] = { sum: 0, count: 0 };
                months[m].sum += historyData[k].percent;
                months[m].count += 1;
            });
            const mKeys = Object.keys(months).sort().slice(-6);
            mKeys.forEach(m => {
                const avg = Math.round(months[m].sum / months[m].count);
                const mon = parseInt(m.split('-')[1], 10);
                data.push({ label: `${mon}ì›”`, value: avg });
            });
        } else {
            const years = {};
            dateKeys.forEach(k => {
                const y = k.substring(0, 4);
                if(!years[y]) years[y] = { sum: 0, count: 0 };
                years[y].sum += historyData[k].percent;
                years[y].count += 1;
            });
            const yKeys = Object.keys(years).sort().slice(-5);
            yKeys.forEach(y => {
                const avg = Math.round(years[y].sum / years[y].count);
                data.push({ label: y, value: avg });
            });
        }
        return data;
    };

    return (
      <div className="space-y-6 animate-fade-in max-w-2xl mx-auto relative pb-20">
        <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex justify-between items-center mt-8">
            <div><h2 className="text-2xl font-black text-slate-800">SRS Master ğŸ§ </h2><p className="text-slate-500 text-sm mt-1">ê³¼í•™ì  ë°˜ë³µ í•™ìŠµ ì‹œìŠ¤í…œ</p></div>
            <div className="flex flex-col items-center bg-orange-50 px-4 py-2 rounded-2xl border border-orange-100"><Flame className="text-orange-500 mb-1" size={20}/><span className="font-bold text-orange-700 text-sm">{streak}ì¼ì§¸</span></div>
        </div>

        {showRefillAlert && (
            <div className="bg-red-50 border border-red-200 p-4 rounded-2xl flex justify-between items-center animate-pulse-slow">
                <div className="flex items-center gap-3">
                    <div className="bg-red-100 p-2 rounded-full text-red-600"><BatteryCharging size={24}/></div>
                    <div><div className="font-bold text-red-700">ë‹¨ì–´ ì¶©ì „ í•„ìš”!</div><div className="text-xs text-red-500">ì „ì²´ ë³´ìœ  ë‹¨ì–´ê°€ 100ê°œ ë¯¸ë§Œ({words.length}ê°œ)ì…ë‹ˆë‹¤.</div></div>
                </div>
                <button type="button" onClick={handleGitHubSeed} className="px-3 py-1.5 bg-red-600 text-white text-xs font-bold rounded-lg shadow hover:bg-red-700 whitespace-nowrap">+ GitHub ì¶©ì „</button>
            </div>
        )}

        <div className="bg-white p-6 rounded-3xl border border-dashed border-slate-300 text-center">
            <h3 className="font-bold text-slate-700 mb-2 flex items-center justify-center gap-2"><UploadCloud/> ë°ì´í„° ê´€ë¦¬</h3>
            <div className="flex flex-wrap justify-center gap-2 mb-2">
                <input type="file" accept=".csv" ref={fileInputRef} onChange={handleFileUpload} className="hidden" />
                
                {/* Direct GitHub Import Button */}
                <button onClick={handleGitHubSeed} className="px-4 py-2 bg-green-600 text-white rounded-lg font-bold text-sm hover:bg-green-700 flex items-center gap-2"><Github size={16}/> GitHub ë™ê¸°í™”</button>
                
                <button onClick={() => fileInputRef.current?.click()} className="px-4 py-2 bg-indigo-50 text-indigo-700 rounded-lg font-bold text-sm hover:bg-indigo-100 flex items-center gap-2"><FileText size={16}/> ë‚´ íŒŒì¼ ì„ íƒ</button>
                
                {words.length > 0 && <button onClick={clearData} className="px-4 py-2 bg-white text-red-500 border border-red-200 rounded-lg font-bold text-sm hover:bg-red-50"><Trash2 size={16}/></button>}
            </div>
            {uploadStatus && (
                <div className="mt-3">
                    <div className="text-sm font-bold text-indigo-600 animate-pulse mb-1">{uploadStatus}</div>
                    {isUploading && <div className="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden"><div className="bg-indigo-600 h-full transition-all duration-300" style={{width:`${uploadProgress}%`}}></div></div>}
                </div>
            )}
            <div className="mt-2 text-xs text-slate-400">ì´ ë³´ìœ  ë‹¨ì–´: {words.length}ê°œ / ì˜¤ëŠ˜ ë³µìŠµ ëŒ€ìƒ: {dueWords.length}ê°œ</div>
        </div>

        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <button onClick={startRoutine} className={`p-5 bg-gradient-to-br from-indigo-600 to-violet-600 text-white rounded-3xl shadow-lg hover:translate-y-[-2px] transition-transform text-left`}>
                <div className="flex justify-between mb-6"><div className="p-2 bg-white/20 rounded-xl"><Play fill="currentColor" size={20}/></div></div>
                <div className="font-bold text-xl">ì˜¤ëŠ˜ì˜ í•™ìŠµ ì‹œì‘</div>
                <div className="text-white/70 text-sm mt-1">{dueWords.length===0 ? 'ëœë¤ ë‹¨ì–´ í•™ìŠµ' : `í• ë‹¹ëŸ‰: ${Math.min(100, dueWords.length)}ê°œ`}</div>
            </button>
            <button onClick={() => wrongWords.length > 0 && setMode('wrong_review')} className="p-5 bg-white border-2 border-slate-100 rounded-3xl text-left hover:border-orange-200 transition-colors">
                <div className="flex justify-between mb-6"><div className={`p-2 rounded-xl ${wrongWords.length>0?'bg-orange-100 text-orange-600':'bg-slate-100 text-slate-400'}`}><AlertCircle size={20}/></div><span className="text-xs font-bold text-slate-400">{wrongWords.length} Words</span></div>
                <div className="font-bold text-xl text-slate-800">ì˜¤ë‹µ ë…¸íŠ¸</div>
                <div className="text-slate-400 text-sm mt-1">í‹€ë¦° ë‹¨ì–´ ë‹¤ì‹œ ë³´ê¸°</div>
            </button>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch">
            {/* Calendar */}
            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex flex-col h-full">
                <div className="flex justify-between items-center mb-6 h-8 shrink-0">
                    <h3 className="font-bold text-lg flex items-center gap-2"><CalIcon className="text-indigo-600"/> ìº˜ë¦°ë”</h3>
                    <div className="flex gap-1"><button onClick={prevMonth}><ChevronLeft size={16}/></button><span className="text-xs font-bold w-12 text-center">{month+1}ì›”</span><button onClick={nextMonth}><ChevronRight size={16}/></button></div>
                </div>
                <div className="grid grid-cols-7 gap-1 text-center text-xs flex-1 content-start">
                    {['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].map(d=><div key={d} className="text-slate-400 font-bold py-1">{d}</div>)}
                    {days.map((d,i)=>(<div key={i} className={`aspect-square rounded flex items-center justify-center relative ${d?historyData[`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`]?.completed?'bg-green-100 text-green-700 font-bold':'bg-slate-50 text-slate-400':''}`}>{d}</div>))}
                </div>
            </div>
            {/* Chart */}
            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex flex-col h-full">
                <div className="flex justify-between items-center mb-6 h-8 shrink-0">
                    <h3 className="font-bold text-lg flex items-center gap-2"><TrendingUp className="text-indigo-600"/> ì„±ì·¨ë„</h3>
                    <div className="flex bg-slate-100 p-1 rounded-lg">
                        {['week','month','year'].map(t=>(<button key={t} onClick={()=>setChartTab(t)} className={`px-2 py-1 text-[10px] font-bold rounded ${chartTab===t?'bg-white shadow text-indigo-600':'text-slate-400'}`}>{t.toUpperCase()}</button>))}
                    </div>
                </div>
                <div className="flex-1 flex items-center justify-center"><SimpleLineChart data={getChartData()} /></div>
            </div>
        </div>
        
        {/* Dictionary Search */}
        <div className="mt-6 bg-white p-2 rounded-2xl shadow-sm border border-slate-100 flex items-center">
            <Search className="text-slate-400 ml-3" size={20}/>
            <input className="flex-1 p-3 outline-none text-sm" placeholder="ë‹¨ì–´ ëœ» ê²€ìƒ‰ (ì‚¬ì „)" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSearch()}/>
            <button onClick={() => {setMode('dictionary'); handleSearch();}} className="bg-slate-800 text-white px-4 py-2 rounded-xl text-sm font-bold">ê²€ìƒ‰</button>
        </div>
      </div>
    );
  };

  const renderStudyView = () => (
    <div className="max-w-3xl mx-auto h-full flex flex-col animate-fade-in relative pt-20 pb-28">
      <div className="fixed top-4 right-4 z-50 pointer-events-none"><div className="bg-indigo-600 text-white font-mono text-xl font-bold px-4 py-2 rounded-full shadow-2xl border-2 border-indigo-400 flex items-center gap-2 animate-pulse-slow"><Clock size={18}/>{Math.floor(timeLeft/60)}:{(timeLeft%60).toString().padStart(2,'0')}</div></div>
      <div className="flex-1 overflow-y-auto px-4 space-y-3 pb-4">
        {currentTestWords.map((w,i)=>(
          <div key={w.id} className="flex items-center p-4 bg-white border border-slate-200 rounded-xl shadow-sm hover:shadow-md transition-shadow">
             {/* Left Column: Number, Level, Stats */}
             <div className="flex flex-col items-center justify-center w-12 shrink-0 border-r border-slate-100 pr-3 mr-3 gap-1">
                <span className="text-sm font-black text-slate-300">{i+1}</span>
                <div className={`transition-opacity duration-300 ${hideTerm ? 'opacity-0' : 'opacity-100'}`}><LevelBadge level={w.level}/><StatBadge correct={w.correctCount} total={w.totalAttempts}/></div>
             </div>
             <div className={`flex-1 transition-opacity duration-300 ${hideTerm ? 'opacity-0' : 'opacity-100'}`}><span className="font-bold text-xl text-slate-800 break-words">{w.term}</span></div>
             <div className={`flex-1 text-right transition-opacity duration-300 ${hideDef ? 'opacity-0' : 'opacity-100'}`}><span className="text-indigo-600 font-medium text-lg break-keep">{w.definition}</span></div>
          </div>
        ))}
      </div>
      <div className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 p-3 z-50 shadow-lg-up safe-area-pb"><div className="max-w-3xl mx-auto flex gap-2 h-14"><button onClick={startTest} className="flex-[2] bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 flex items-center justify-center gap-2 active:scale-95"><CheckCircle size={20}/> ì‹œí—˜ ë³´ê¸°</button><button onClick={()=>setHideTerm(!hideTerm)} className={`flex-1 font-bold rounded-xl border flex flex-col items-center justify-center text-[10px] gap-1 ${hideTerm?'bg-slate-800 text-white':'bg-white text-slate-600'}`}>{hideTerm?<EyeOff size={18}/>:<Eye size={18}/>} ë‹¨ì–´</button><button onClick={()=>setHideDef(!hideDef)} className={`flex-1 font-bold rounded-xl border flex flex-col items-center justify-center text-[10px] gap-1 ${hideDef?'bg-slate-800 text-white':'bg-white text-slate-600'}`}>{hideDef?<EyeOff size={18}/>:<Eye size={18}/>} ëœ»</button></div></div>
    </div>
  );

  const renderTestView = () => (
    <div className="max-w-3xl mx-auto h-full flex flex-col animate-fade-in relative pt-20 pb-20">
       <div className="fixed top-4 right-4 z-50 pointer-events-none"><div className="bg-rose-600 text-white font-mono text-xl font-bold px-4 py-2 rounded-full shadow-2xl border-2 border-rose-400 flex items-center gap-2"><Clock size={18}/>{Math.floor(timeLeft/60)}:{(timeLeft%60).toString().padStart(2,'0')}</div></div>
       <div className="flex-1 overflow-y-auto px-4 pb-4 space-y-3">
           {currentTestWords.map((w,i)=>(
             <div key={w.id} className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col sm:flex-row sm:items-center gap-2">
               <div className="flex items-center gap-2 w-full sm:w-1/3">
                   <span className="w-8 text-sm font-black text-slate-300 text-center shrink-0 border-r border-slate-100 pr-2">{i+1}</span>
                   <span className="font-bold text-slate-800 text-lg">{w.term}</span>
               </div>
               {/* Prevent Enter key from submitting the form */}
               <input 
                 className="flex-1 w-full border-b-2 border-slate-200 p-2 bg-transparent focus:border-rose-500 focus:outline-none text-base" 
                 placeholder="ëœ» ì…ë ¥" 
                 value={userAnswers[w.id]||''} 
                 onChange={e=>setUserAnswers({...userAnswers,[w.id]:e.target.value})} 
                 autoComplete="off"
                 onKeyDown={(e) => { if(e.key === 'Enter') e.preventDefault(); }}
               />
             </div>
           ))}
       </div>
       <div className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 p-4 z-50 shadow-lg-up"><div className="max-w-3xl mx-auto"><button onClick={submitTest} className="w-full py-4 text-white font-bold rounded-xl shadow-lg bg-rose-600 hover:bg-rose-700 active:scale-95">ì œì¶œí•˜ê¸°</button></div></div>
    </div>
  );

  const renderResultView = () => (
    <div className="max-w-2xl mx-auto bg-white min-h-screen p-6 pb-20">
      <div className="text-center py-8"><div className="inline-block p-4 bg-yellow-50 rounded-full mb-4 animate-bounce"><CheckCircle size={48} className="text-yellow-500"/></div><h2 className="text-3xl font-black text-slate-800 mb-2">ì ìˆ˜: {score} / {currentTestWords.length}</h2></div>
      <div className="bg-slate-50 rounded-3xl p-6 mb-6">
        <div className="space-y-2 max-h-[50vh] overflow-y-auto custom-scrollbar pr-2">
            {currentTestWords.length === 0 ? <p className="text-center text-slate-400 p-4">ê²°ê³¼ ë°ì´í„° ì—†ìŒ</p> : 
            currentTestWords.map(w => {
                const res = gradedResults[w.id] || { isCorrect: false };
                if(!isRetest && res.isCorrect && res.type === 'exact') return null;
                return (
                    <div key={w.id} className={`flex justify-between items-center p-3 rounded-xl border ${res.isCorrect ? 'bg-green-50 border-green-200' : 'bg-white border-slate-200'}`}>
                        <div>
                            <div className="flex items-center gap-2 mb-1"><span className="font-bold text-slate-800">{w.term}</span><LevelBadge level={w.level}/></div>
                            <span className={`${res.isCorrect ? 'text-green-700' : 'text-red-500 line-through'}`}>{userAnswers[w.id]||'(ë¯¸ì…ë ¥)'}</span>
                        </div>
                        <span className="text-xs text-slate-500 text-right ml-2">{w.definition}</span>
                    </div>
                )
            })}
        </div>
      </div>
      <div className="fixed bottom-6 left-6 right-6 max-w-2xl mx-auto"><button onClick={()=>setMode('dashboard')} className="w-full py-4 bg-slate-800 text-white font-bold rounded-2xl shadow-lg active:scale-95">ë©”ì¸ìœ¼ë¡œ</button></div>
    </div>
  );

  const renderWrongReviewView = () => (
      <div className="max-w-2xl mx-auto p-4 pt-8 h-screen flex flex-col">
          <div className="flex justify-between items-center mb-6"><h2 className="font-bold text-2xl flex items-center gap-2"><AlertCircle className="text-orange-600"/> ì˜¤ë‹µ ë…¸íŠ¸</h2><button onClick={()=>setMode('dashboard')} className="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center">âœ•</button></div>
          <div className="bg-gradient-to-r from-orange-500 to-red-500 rounded-2xl p-6 text-white mb-6 shadow-lg"><div className="flex justify-between items-end"><div><p className="opacity-80 text-sm mb-1">ì´ í‹€ë¦° ë‹¨ì–´</p><div className="text-4xl font-black">{wrongWords.length}ê°œ</div></div><button onClick={startWrongRetest} className="px-5 py-2 bg-white text-orange-600 font-bold rounded-xl hover:bg-orange-50 flex items-center gap-2 active:scale-95"><Play size={16}/> ì¬ì‹œí—˜</button></div></div>
          <div className="flex-1 overflow-y-auto space-y-2 pb-10 pr-1 custom-scrollbar">{wrongWords.map(w=>(<div key={w.id} className="p-4 bg-white border border-slate-200 rounded-2xl flex justify-between items-center shadow-sm"><div><div className="flex items-center gap-2"><div className="font-bold text-lg text-slate-800">{w.term}</div><LevelBadge level={w.level}/></div><div className="text-sm text-slate-500 mt-1">ì •ë‹µ: {w.definition}</div><div className="text-xs text-red-400 mt-1">ë‹µ: {w.userWrongAnswer || 'ë¯¸ì…ë ¥'}</div></div></div>))}</div>
      </div>
  );

  const DictionaryView = () => (
      <div className="max-w-xl mx-auto py-10 px-6">
          <button onClick={() => setMode('dashboard')} className="mb-6 flex items-center text-slate-500 hover:text-slate-800"><ChevronLeft/> ë©”ì¸ìœ¼ë¡œ</button>
          <div className="bg-white p-8 rounded-3xl shadow-lg border border-slate-100 text-center">
              <Book className="mx-auto text-indigo-600 mb-4" size={48}/>
              <h2 className="text-3xl font-black text-slate-800 mb-2">{searchResult?.term || searchTerm}</h2>
              <div className="w-12 h-1 bg-indigo-100 mx-auto mb-6 rounded-full"></div>
              <p className="text-lg text-slate-600 font-medium leading-relaxed">{searchResult?.definition || "ê²€ìƒ‰ ì¤‘..."}</p>
              <div className="mt-6 pt-6 border-t border-slate-100">
                  <a href={`https://dict.naver.com/search.dict?dicQuery=${searchTerm}`} target="_blank" rel="noreferrer" className="text-indigo-500 hover:underline text-sm">
                      ë„¤ì´ë²„ ì‚¬ì „ì—ì„œ ë” ë³´ê¸° &rarr;
                  </a>
              </div>
          </div>
      </div>
  );

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-10">
      {mode === 'loading' && <div className="flex items-center justify-center h-screen text-slate-400">Loading...</div>}
      {mode === 'dashboard' && DashboardView()}
      {mode === 'study' && renderStudyView()}
      {mode === 'test' && renderTestView()}
      {mode === 'result' && renderResultView()}
      {mode === 'wrong_review' && renderWrongReviewView()}
      {mode === 'dictionary' && DictionaryView()}
    </div>
  );
}
