<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SRS TOEIC Master</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .7; } }
        .perspective-1000 { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="importmap">
        {
            "imports": {
                "firebase/app": "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js"
            }
        }
    </script>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "firebase/app";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "firebase/auth";
        import { getFirestore, collection, doc, query, where, orderBy, limit, serverTimestamp, writeBatch, onSnapshot, getDocs, getCountFromServer, deleteDoc, updateDoc } from "firebase/firestore";


        // ★ 사용자 설정 적용됨 ★
        const firebaseConfig = {
            apiKey: "AIzaSyDPy1S4eIvDUeVpTo_aegrcQyE1uSdymfo",
            authDomain: "word-en.firebaseapp.com",
            projectId: "word-en",
            storageBucket: "word-en.firebasestorage.app",
            messagingSenderId: "16859654456",
            appId: "1:16859654456:web:1b33cfbc12bf547c1279cd",
            measurementId: "G-PGCSWRLVKM"
        };
        let auth, db, appId;
        let initError = null;

        try {
            const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
            // 설정 검증 완화: 키가 없어도 일단 앱이 켜지게 함 (로그인 화면에서 에러 띄움)
            const app = initializeApp(config);
            auth = getAuth(app);
            db = getFirestore(app);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        } catch (e) { 
            console.error("Firebase Init Error:", e); 
            initError = e.message;
        }

        const { useState, useEffect, useRef } = React;

        // --- Icons (내장) ---
        const IconBase = ({ children, size = 24, className = "" }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const BookOpen = (props) => <IconBase {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const Edit3 = (props) => <IconBase {...props}><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></IconBase>;
        const CalIcon = (props) => <IconBase {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const Play = (props) => <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3"/></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></IconBase>;
        const TrendingUp = (props) => <IconBase {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconBase>;
        const ChevronLeft = (props) => <IconBase {...props}><polyline points="15 18 9 12 15 6"/></IconBase>;
        const ChevronRight = (props) => <IconBase {...props}><polyline points="9 18 15 12 9 6"/></IconBase>;
        const Flame = (props) => <IconBase {...props}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3.7-1.7 1.2-2.7 1.9-3.7z"/></IconBase>;
        const Shuffle = (props) => <IconBase {...props}><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></IconBase>;
        const Eye = (props) => <IconBase {...props}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const EyeOff = (props) => <IconBase {...props}><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07-2.3 2.3"/><line x1="1" y1="1" x2="23" y2="23"/></IconBase>;
        const Clock = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const Brain = (props) => <IconBase {...props}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></IconBase>;
        const BatteryCharging = (props) => <IconBase {...props}><path d="M5 18H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h3.19M15 6h2a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-3.19"/><line x1="23" y1="13" x2="23" y2="11"/><polyline points="11 6 7 12 13 12 9 18"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>;
        const UploadCloud = (props) => <IconBase {...props}><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/><polyline points="16 16 12 12 8 16"/></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>;
        const X = (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>;
        const Settings = (props) => <IconBase {...props}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconBase>;
        const Book = (props) => <IconBase {...props}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></IconBase>;
        const Github = (props) => <IconBase {...props}><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></IconBase>;
        const Loader2 = (props) => <IconBase {...props} className={props.className + " animate-spin"}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>;
        const LogOut = (props) => <IconBase {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></IconBase>;

        // --- Seed Data ---
        const CEFR_100_SEED = [
            {term:"abandon",definition:"버리다, 포기하다",level:"B2"},{term:"ability",definition:"능력, 재능",level:"A2"},{term:"absolute",definition:"절대적인",level:"B2"},{term:"abstract",definition:"추상적인",level:"C1"},{term:"accumulate",definition:"축적하다",level:"C1"},
            {term:"barrier",definition:"장벽",level:"B2"},{term:"calculate",definition:"계산하다",level:"B2"},{term:"campaign",definition:"캠페인",level:"C1"},{term:"debate",definition:"토론",level:"B2"},{term:"decade",definition:"10년",level:"B1"},
            // ... (생략)
            {term:"effort",definition:"노력",level:"B1"},{term:"factory",definition:"공장",level:"A2"},{term:"gather",definition:"모이다",level:"B1"},{term:"habit",definition:"습관",level:"A2"},{term:"identical",definition:"동일한",level:"B2"}
        ];

        const GITHUB_CSV_URL = "https://raw.githubusercontent.com/cblpan/100words_EN/refs/heads/main/CEFR_10000_EN.csv";

        // --- Helpers ---
        const getSimilarity = (s1, s2) => {
            if (!s1 || !s2) return 0;
            const l = s1.length > s2.length ? s1 : s2;
            const s = s1.length > s2.length ? s2 : s1;
            if (l.length === 0) return 1.0;
            const costs = new Array();
            for (let i = 0; i <= l.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s.length; j++) {
                    if (i === 0) costs[j] = j;
                    else {
                        if (j > 0) {
                            let newValue = costs[j - 1];
                            if (l.charAt(i - 1) !== s.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                            costs[j - 1] = lastValue;
                            lastValue = newValue;
                        }
                    }
                }
                if (i > 0) costs[s.length] = lastValue;
            }
            return (l.length - costs[s.length]) / l.length;
        };

        const calculateNextReview = (currentInterval, isCorrect) => {
            if (!isCorrect) return 0; 
            if (currentInterval === 0) return 1;
            if (currentInterval === 1) return 3;
            if (currentInterval === 3) return 7;
            if (currentInterval === 7) return 14;
            if (currentInterval === 14) return 30;
            return Math.floor(currentInterval * 2);
        };

        const parseCSV = (text) => {
            const lines = text.replace(/\r\n/g, '\n').split('\n').filter(l => l.trim());
            if (lines.length < 2) return [];
            const parseLine = (line) => {
                const res = []; let start = 0, inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    if (line[i] === '"') inQuotes = !inQuotes;
                    else if (line[i] === ',' && !inQuotes) { res.push(line.substring(start, i)); start = i + 1; }
                }
                res.push(line.substring(start));
                return res.map(c => c.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
            };
            const headers = parseLine(lines[0]).map(h => h.toLowerCase());
            let termIdx = 0, levelIdx = 1, defIdx = 2;
            headers.forEach((h, i) => {
                if(h.includes('word') || h.includes('term')) termIdx = i;
                if(h.includes('level') || h.includes('cefr')) levelIdx = i;
                if(h.includes('def') || h.includes('mean')) defIdx = i;
            });
            return lines.slice(1).map(line => {
                const cols = parseLine(line);
                if(cols.length < 2) return null;
                return { term: cols[termIdx] || "Unknown", level: cols[levelIdx] || "??", definition: cols[defIdx] || "뜻 없음" };
            }).filter(Boolean);
        };

        const SimpleLineChart = ({ data, color = "#4f46e5" }) => {
            if (!data || data.length === 0) return <div className="h-40 flex items-center justify-center text-slate-400 text-xs bg-slate-50 rounded-xl border border-slate-100 w-full">데이터가 부족합니다</div>;
            const width = 300, height = 150, pX = 30, pY = 20;
            const cH = height - pY * 2, cW = width - pX * 2;
            const maxVal = 100;
            const points = data.map((d, i) => {
                const x = pX + (i * cW) / (data.length - 1 || 1);
                const y = height - pY - ((d.value / maxVal) * cH);
                return `${x},${y}`;
            }).join(' ');
            return (
                <div className="w-full h-40 overflow-hidden">
                <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full">
                    <line x1={pX} y1={height - pY} x2={width - pX} y2={height - pY} stroke="#e2e8f0" strokeWidth="1" />
                    <polyline fill="none" stroke={color} strokeWidth="2" points={points} />
                    {data.map((d, i) => {
                        const x = pX + (i * cW) / (data.length - 1 || 1);
                        const val = isNaN(d.value) ? 0 : Math.round(d.value);
                        const y = height - pY - ((val / maxVal) * cH);
                        return (
                            <g key={i}>
                                <circle cx={x} cy={y} r="3" fill="white" stroke={color} strokeWidth="2" />
                                <text x={x} y={height - 5} textAnchor="middle" fontSize="10" fill="#94a3b8">{d.label}</text>
                                {(i === data.length - 1 || data.length < 5) && <text x={x} y={y - 8} textAnchor="middle" fontSize="10" fill="#64748b" fontWeight="bold">{val}%</text>}
                            </g>
                        );
                    })}
                </svg>
                </div>
            );
        };

        // --- Login Component ---
        const LoginView = ({ setMode }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isSignUp, setIsSignUp] = useState(false);
            const [error, setError] = useState('');

            const handleEmailAuth = async () => {
                setError('');
                if (!auth) { setError("Firebase 초기화 실패"); return; }
                try {
                    if (isSignUp) {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (e) {
                    setError(e.message.includes('auth/') ? "이메일 또는 비밀번호를 확인하세요." : e.message);
                }
            };

            const handleGoogle = () => {
                setError('');
                if (!auth) { setError("Firebase 초기화 실패"); return; }
                const provider = new GoogleAuthProvider();
                signInWithPopup(auth, provider)
                    .catch((e) => {
                        console.error(e);
                        setError("Google 로그인 실패. 팝업 차단을 확인하세요.");
                    });
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-6 bg-slate-50">
                    <div className="w-full max-w-md bg-white p-8 rounded-3xl shadow-xl border border-slate-100">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-black text-indigo-700 mb-2">SRS TOEIC</h1>
                            <p className="text-slate-400 text-sm">뇌과학 기반 토익 영단어 마스터</p>
                        </div>
                        <div className="space-y-4">
                            <input type="email" placeholder="이메일" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all"/>
                            <input type="password" placeholder="비밀번호 (6자리 이상)" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all" onKeyDown={e=>e.key==='Enter' && handleEmailAuth()}/>
                            {error && <p className="text-red-500 text-sm text-center font-bold">{error}</p>}
                            <button onClick={handleEmailAuth} className="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-transform active:scale-95">
                                {isSignUp ? '회원가입' : '로그인'}
                            </button>
                            <div className="relative my-6"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-200"></div></div><div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-slate-400">또는</span></div></div>
                            <button onClick={handleGoogle} className="w-full py-4 bg-white border-2 border-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-50 transition-colors flex items-center justify-center gap-2">
                                <svg className="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg> Google로 계속하기
                            </button>
                            <p className="text-center text-sm text-slate-400 mt-4">
                                {isSignUp ? '이미 계정이 있나요?' : '아직 계정이 없나요?'} 
                                <button onClick={()=>setIsSignUp(!isSignUp)} className="ml-1 text-indigo-600 font-bold hover:underline">{isSignUp ? '로그인' : '회원가입'}</button>
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        function App() {
            const [user, setUser] = useState(null);
            
            // Data States
            const [dueWords, setDueWords] = useState([]); 
            const [wrongWords, setWrongWords] = useState([]);
            const [historyData, setHistoryData] = useState({});
            const [streak, setStreak] = useState(0);
            const [totalWordsCount, setTotalWordsCount] = useState(0);
            
            // UI States
            const [mode, setMode] = useState('loading');
            const [currentDate, setCurrentDate] = useState(new Date());
            const [chartTab, setChartTab] = useState('week'); 
            const [isUploading, setIsUploading] = useState(false);
            const [uploadProgress, setUploadProgress] = useState(0);
            const [uploadStatus, setUploadStatus] = useState('');
            const [appError, setAppError] = useState(initError);
            
            // Test States
            const [hideTerm, setHideTerm] = useState(false);
            const [hideDef, setHideDef] = useState(false);
            const [currentTestWords, setCurrentTestWords] = useState([]);
            const [isRetest, setIsRetest] = useState(false);
            const [timeLeft, setTimeLeft] = useState(600);
            const [isActive, setIsActive] = useState(false);
            const [userAnswers, setUserAnswers] = useState({});
            const [score, setScore] = useState(0);
            const [gradedResults, setGradedResults] = useState({});
            
            const [searchTerm, setSearchTerm] = useState('');
            const [searchResult, setSearchResult] = useState(null);
            const fileInputRef = useRef(null);
            const initialLoadComplete = useRef(false);
            const loadTimerRef = useRef(null);

            // Auth Check
            useEffect(() => {
                if (initError) { setAppError(initError); return; }
                if (!auth) {
                    // If auth is not initialized but no error, force login view
                    if (!appError) setMode('login');
                    return;
                }

                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (currentUser) {
                        if (!initialLoadComplete.current) {
                            initialLoadComplete.current = true;
                            setMode('dashboard');
                        }
                    } else {
                        setMode('login');
                    }
                });
                return () => unsubscribe();
            }, []);

            // Data Sync
            useEffect(() => {
                if (!user || !db) return;
                
                const qDue = query(collection(db, 'artifacts', appId, 'users', user.uid, 'vocabulary'), where('nextReviewDate', '<=', new Date()), limit(200));
                const unsubDue = onSnapshot(qDue, (snap) => {
                    const due = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    setDueWords(due);
                    if (!initialLoadComplete.current) {
                        initialLoadComplete.current = true;
                        setMode('dashboard');
                    }
                }, (err) => {
                    // Error handling for permission issues etc.
                    console.error("Data Load Error:", err);
                });

                const unsubHistory = onSnapshot(query(collection(db, 'artifacts', appId, 'users', user.uid, 'history')), (snap) => {
                    const h = {}; snap.forEach(d => h[d.id] = d.data()); setHistoryData(h);
                    let s = 0; const t = new Date(); for(let i=0; i<365; i++) { const d = new Date(); d.setDate(t.getDate()-i); if(h[d.toISOString().split('T')[0]]?.completed) s++; else if(i>0) break; } setStreak(s);
                });
                const unsubWrong = onSnapshot(query(collection(db, 'artifacts', appId, 'users', user.uid, 'wrong_answers')), (snap) => {
                    setWrongWords(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });
                getCountFromServer(collection(db, 'artifacts', appId, 'users', user.uid, 'vocabulary')).then(snapshot => { setTotalWordsCount(snapshot.data().count); }).catch(e => {});

                return () => { unsubDue(); unsubHistory(); unsubWrong(); };
            }, [user]);

            // ... (Rest of logic: seed, clear, upload, study, test, search)
             useEffect(() => {
                let interval = null;
                if (isActive && timeLeft > 0) interval = setInterval(() => setTimeLeft(t => t-1), 1000);
                else if (timeLeft === 0) { clearInterval(interval); handleTimeout(); }
                return () => clearInterval(interval);
            }, [isActive, timeLeft]);

            const handleTimeout = () => {
                setIsActive(false);
                alert(mode === 'study' ? "암기 종료! 시험 시작" : "시험 종료! 제출");
                if (mode === 'study') startTest(); else submitTest();
            };

            useEffect(() => {
                if (mode === 'study' && currentTestWords.length > 0) {
                    const fetchMissing = async () => {
                        const newWords = [...currentTestWords];
                        let hasUpdates = false;
                        for (let i = 0; i < newWords.length; i++) {
                            if (!newWords[i].definition) {
                                try {
                                    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${newWords[i].term}`);
                                    if (res.ok) {
                                        const data = await res.json();
                                        if (data[0]?.meanings[0]?.definitions[0]?.definition) {
                                            newWords[i].definition = data[0].meanings[0].definitions[0].definition;
                                            hasUpdates = true;
                                        }
                                    }
                                } catch(e) {}
                            }
                        }
                        if (hasUpdates) setCurrentTestWords(newWords);
                    };
                    fetchMissing();
                }
            }, [mode, currentTestWords]);

            const seedData = async () => {
                if(!user) return;
                setIsUploading(true); setUploadProgress(10);
                const batch = writeBatch(db);
                CEFR_100_SEED.forEach(w => {
                    const ref = doc(collection(db, 'artifacts', appId, 'users', user.uid, 'vocabulary'));
                    batch.set(ref, { ...w, createdAt: serverTimestamp(), correctCount: 0, totalAttempts: 0, interval: 0, nextReviewDate: new Date() });
                });
                await batch.commit();
                setTotalWordsCount(prev => prev + CEFR_100_SEED.length);
                setUploadProgress(100); setTimeout(()=>{ setIsUploading(false); setUploadProgress(0); }, 1000);
            };

            const clearData = async () => {
                if(!user || !confirm("정말 모든 단어를 삭제하시겠습니까?")) return;
                setIsUploading(true); setUploadProgress(50);
                const snap = await getDocs(collection(db, 'artifacts', appId, 'users', user.uid, 'vocabulary'));
                const batch = writeBatch(db);
                snap.forEach(d => batch.delete(d.ref));
                await batch.commit();
                setTotalWordsCount(0); setDueWords([]); setUploadProgress(100);
                setTimeout(()=> { setIsUploading(false); setUploadProgress(0); }, 1000);
            };

            const handleGitHubSeed = async () => {
                if(!user) return;
                if(!confirm("GitHub에서 데이터를 받아오시겠습니까?")) return;
                setIsUploading(true); setUploadStatus('다운로드...'); setUploadProgress(10);
                try {
                    const response = await fetch(GITHUB_CSV_URL);
                    if (!response.ok) throw new Error("연결 실패");
                    const csvText = await response.text();
                    setUploadStatus('분석...'); setUploadProgress(30);
                    const data = parseCSV(csvText);
                    setUploadStatus(`${data.length}개 저장...`);
                    const BATCH_SIZE = 500;
                    const batches = [];
                    for (let i = 0; i < data.length; i += BATCH_SIZE) batches.push(data.slice(i, i + BATCH_SIZE));
                    let completed = 0;
                    for (const chunk of batches) {
                        const batch = writeBatch(db);
                        chunk.forEach(w => {
                            const ref = doc(collection(db, 'artifacts', appId, 'users', user.uid, 'vocabulary'));
                            batch.set(ref, { 
                                ...w, 
                                createdAt: serverTimestamp(), 
                                correctCount: 0, 
                                totalAttempts: 0, 
                                interval: 0, 
                                nextReviewDate: new Date() 
                            });
                        });
                        await batch.commit();
                        completed++;
                        setUploadProgress(30 + Math.round((completed / batches.length) * 70));
                    }
                    setTotalWordsCount(prev => prev + data.length);
                    alert("완료!");
                } catch (error) { console.error(error); alert(`오류: ${error.message}`); } 
                finally { setIsUploading(false); setUploadStatus(''); setUploadProgress(0); }
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file || !user) return;
                setIsUploading(true); setUploadProgress(5); setUploadStatus('읽는 중...');
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const data = parseCSV(evt.target.result);
                        setUploadStatus(`${data.length}개 저장...`);
                        const BATCH_SIZE = 500;
                        const batches = [];
                        for (let i = 0; i < data.length; i += BATCH_SIZE) batches.push(data.slice(i, i + BATCH_SIZE));
                        let completed = 0;
                        for (const chunk of batches) {
                            const batch = writeBatch(db);
                            chunk.forEach(w => {
                                const ref = doc(collection(db, 'artifacts', appId, 'users', user.uid, 'vocabulary'));
                                batch.set(ref, { ...w, createdAt: serverTimestamp(), correctCount: 0, totalAttempts: 0, interval: 0, nextReviewDate: new Date() });
                            });
                            await batch.commit();
                            completed++;
                            setUploadProgress(Math.round((completed / batches.length) * 100));
                        }
                        setTotalWordsCount(prev => prev + data.length);
                    } catch (err) { alert("오류"); }
                    finally { setIsUploading(false); setUploadStatus(''); setUploadProgress(0); }
                };
                reader.readAsText(file);
            };

            const startRoutine = () => {
                if (dueWords.length === 0 && totalWordsCount === 0) return alert("단어장이 비어있습니다.");
                let sessionWords = dueWords;
                if (sessionWords.length === 0) {
                    if (!confirm("오늘 복습 완료! 랜덤 20개로 더 공부할까요?")) return;
                    return alert("랜덤 학습 기능 준비중");
                }
                const selected = sessionWords.sort(() => Math.random() - 0.5).slice(0, 50);
                setCurrentTestWords(selected);
                setIsRetest(false); setMode('study'); setTimeLeft(600); setIsActive(true);
                setHideTerm(false); setHideDef(false);
            };

            const startWrongRetest = () => {
                const s = [...wrongWords].sort(() => Math.random() - 0.5);
                setCurrentTestWords(s); setIsRetest(true); setMode('test');
                setTimeLeft(Math.min(600, s.length * 15 + 30)); setIsActive(true); setUserAnswers({});
            };

            const startTest = () => { setMode('test'); if(!isRetest) setTimeLeft(600); setIsActive(true); setUserAnswers({}); window.scrollTo(0,0); };

            const formatTime = (seconds) => {
                const m = Math.max(0, Math.floor(seconds / 60)).toString().padStart(2, '0');
                const s = Math.max(0, seconds % 60).toString().padStart(2, '0');
                return `${m}:${s}`;
            };

            const checkAnswer = (answer, definition) => {
                const user = (answer || '').trim().toLowerCase();
                const expected = (definition || '').trim().toLowerCase();
                if (!user) return { isCorrect: false, similarity: 0 };
                if (expected && expected.includes(user)) return { isCorrect: true, similarity: 1 };
                const similarity = getSimilarity(user, expected);
                return { isCorrect: similarity >= 0.6, similarity };
            };

            const submitTest = async (e) => {
                if(e) e.preventDefault();
                setIsActive(false);
                let c = 0; const todayStr = new Date().toISOString().split('T')[0];
                const newG = {};
                currentTestWords.forEach(w => {
                    const ans = userAnswers[w.id] || '';
                    const res = checkAnswer(ans, w.definition);
                    newG[w.id] = res;
                    if (res.isCorrect) c++;
                });
                setScore(c); setGradedResults(newG); setMode('result'); 
                try {
                    const batch = writeBatch(db);
                    currentTestWords.forEach(w => {
                        const res = newG[w.id] || { isCorrect: false };
                        const wrongRef = doc(db, 'artifacts', appId, 'users', user.uid, 'wrong_answers', w.id);
                        const ans = userAnswers[w.id] || '';
                        if (res.isCorrect) { if (isRetest) batch.delete(wrongRef); } else { batch.set(wrongRef, { term: w.term, definition: w.definition, level: w.level||'', lastMissed: todayStr, userWrongAnswer: ans }); }
                        if (!isRetest) {
                            const wRef = doc(db, 'artifacts', appId, 'users', user.uid, 'vocabulary', w.id);
                            const nInt = calculateNextReview(w.interval||0, res.isCorrect);
                            const nDate = new Date(); nDate.setDate(nDate.getDate()+nInt);
                            batch.update(wRef, { correctCount: (w.correctCount||0)+(res.isCorrect?1:0), totalAttempts: (w.totalAttempts||0)+1, interval: nInt, nextReviewDate: nDate });
                        }
                    });
                    if (!isRetest) {
                        const hRef = doc(db, 'artifacts', appId, 'users', user.uid, 'history', todayStr);
                        batch.set(hRef, { score: c, total: currentTestWords.length, percent: Math.round((c/currentTestWords.length)*100), timestamp: serverTimestamp(), completed: true });
                    }
                    await batch.commit();
                } catch (err) { console.error("Save failed", err); }
            };

            const handleAnswerChange = (wordId, value) => {
                setUserAnswers(prev => ({ ...prev, [wordId]: value }));
            };

            const handleSearch = async () => {
                if(!searchTerm) return;
                setSearchResult({ term: searchTerm, definition: "검색 중...", level: '...' });
                try {
                    const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'vocabulary'), where('term', '==', searchTerm), limit(1));
                    const snap = await getDocs(q);
                    if (!snap.empty) { setSearchResult(snap.docs[0].data()); return; }
                    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${searchTerm}`);
                    if(res.ok) {
                        const data = await res.json();
                        if(data[0]) { setSearchResult({ term: searchTerm, definition: data[0].meanings[0].definitions[0].definition, level: 'Web' }); return; }
                    }
                    setSearchResult({ term: searchTerm, definition: "결과 없음", level: '?' });
                } catch (e) { setSearchResult({ term: searchTerm, definition: "오류", level: '?' }); }
            };

            const handleSignOut = () => { signOut(auth).then(() => setMode('login')); };

            const DashboardView = () => {
                const dayLabels = ['일', '월', '화', '수', '목', '금', '토'];
                const chartDays = chartTab === 'month' ? 30 : 7;
                const chartData = (() => {
                    const result = [];
                    for (let i = chartDays - 1; i >= 0; i--) {
                        const d = new Date();
                        d.setDate(d.getDate() - i);
                        const key = d.toISOString().split('T')[0];
                        result.push({
                            label: chartTab === 'week' ? dayLabels[d.getDay()] : `${d.getMonth() + 1}/${d.getDate()}`,
                            value: historyData[key]?.percent || 0
                        });
                    }
                    return result;
                })();
                const duePreview = dueWords.slice(0, 8);
                const wrongPreview = wrongWords.slice(0, 5);
                const todayLabel = currentDate.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'short' });

                return (
                    <div className="max-w-6xl mx-auto px-4 pt-16 pb-10 space-y-8">
                        <input ref={fileInputRef} type="file" accept=".csv,.txt" className="hidden" onChange={handleFileUpload}/>
                        <section className="bg-white border border-slate-100 rounded-3xl p-6 flex flex-col md:flex-row md:items-center md:justify-between gap-6 shadow-sm">
                            <div>
                                <p className="text-xs font-bold uppercase tracking-wide text-slate-400">{todayLabel}</p>
                                <h2 className="text-2xl md:text-3xl font-black text-slate-800 mt-1">환영합니다, {user?.email?.split('@')[0] || '학습자'}님!</h2>
                                <p className="text-sm text-slate-500 mt-2">오늘 복습 예정 단어 {dueWords.length}개, 바로 시작해볼까요?</p>
                            </div>
                            <div className="flex flex-wrap gap-3">
                                <button onClick={startRoutine} className="px-5 py-3 bg-indigo-600 text-white font-bold rounded-2xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-colors">오늘의 루틴 시작</button>
                                <button onClick={() => setMode('dictionary')} className="px-5 py-3 bg-white border border-slate-200 text-slate-600 font-semibold rounded-2xl hover:border-indigo-200 hover:text-indigo-500 transition-colors">사전 보기</button>
                            </div>
                        </section>

                        {isUploading && (
                            <section className="bg-indigo-50 border border-indigo-100 rounded-2xl p-4">
                                <div className="flex items-center justify-between text-sm text-slate-600 mb-2">
                                    <span>업로드 중... {uploadStatus || ''}</span>
                                    <span className="font-semibold text-indigo-600">{uploadProgress}%</span>
                                </div>
                                <div className="w-full h-2 bg-white rounded-full overflow-hidden">
                                    <div className="h-full bg-indigo-500 transition-all" style={{ width: `${uploadProgress}%` }}></div>
                                </div>
                            </section>
                        )}

                        <section className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
                            {[
                                { label: '오늘 복습', value: dueWords.length, icon: <Clock size={18}/> },
                                { label: '틀린 단어', value: wrongWords.length, icon: <AlertCircle size={18}/> },
                                { label: '전체 단어', value: totalWordsCount, icon: <Book size={18}/> },
                                { label: '연속 학습', value: `${streak}일`, icon: <Flame size={18}/> },
                            ].map((card, idx) => (
                                <div key={idx} className="bg-white rounded-2xl border border-slate-100 p-4 shadow-sm flex items-center gap-4">
                                    <div className="p-3 rounded-xl bg-slate-50 text-indigo-600">{card.icon}</div>
                                    <div>
                                        <p className="text-xs text-slate-400 font-semibold uppercase">{card.label}</p>
                                        <p className="text-2xl font-black text-slate-800 mt-1">{card.value}</p>
                                    </div>
                                </div>
                            ))}
                        </section>

                        <section className="bg-white rounded-3xl border border-slate-100 p-6 shadow-sm">
                            <div className="flex items-center justify-between mb-6">
                                <div>
                                    <p className="text-xs text-slate-400 font-semibold uppercase">진행률</p>
                                    <h3 className="text-xl font-bold text-slate-800 mt-1">최근 {chartTab === 'week' ? '7일' : '30일'} 학습 기록</h3>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={()=>setChartTab('week')} className={`px-3 py-1 text-xs font-bold rounded-full border ${chartTab==='week' ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-500 border-slate-200'}`}>주간</button>
                                    <button onClick={()=>setChartTab('month')} className={`px-3 py-1 text-xs font-bold rounded-full border ${chartTab==='month' ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-500 border-slate-200'}`}>월간</button>
                                </div>
                            </div>
                            <SimpleLineChart data={chartData} />
                        </section>

                        <section className="grid gap-6 lg:grid-cols-2">
                            <div className="bg-white rounded-3xl border border-slate-100 p-6 shadow-sm">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-lg font-bold text-slate-800">오늘 복습 대상</h3>
                                    <span className="text-xs text-slate-400 font-semibold">{dueWords.length} words</span>
                                </div>
                                {duePreview.length === 0 ? (
                                    <p className="text-sm text-slate-400">오늘 복습할 단어가 없습니다. 새로운 단어를 추가해보세요.</p>
                                ) : (
                                    <div className="space-y-3 max-h-72 overflow-y-auto custom-scrollbar pr-1">
                                        {duePreview.map((word) => (
                                            <div key={word.id} className="border border-slate-100 rounded-2xl p-3 hover:border-indigo-100 transition-colors">
                                                <div className="flex items-center justify-between">
                                                    <span className="font-bold text-slate-800">{word.term}</span>
                                                    <span className="text-xs text-slate-400">{word.level || '??'}</span>
                                                </div>
                                                <p className="text-sm text-slate-500 line-clamp-2">{word.definition || '뜻 없음'}</p>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <div className="mt-6 flex flex-wrap gap-3">
                                    <button onClick={startRoutine} className="px-4 py-2 bg-indigo-600 text-white text-sm font-bold rounded-xl">바로 학습</button>
                                    <button onClick={()=>setMode('dictionary')} className="px-4 py-2 bg-white border border-slate-200 text-sm font-bold rounded-xl">사전 검색</button>
                                </div>
                            </div>

                            <div className="bg-white rounded-3xl border border-slate-100 p-6 shadow-sm">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-lg font-bold text-slate-800">틀린 단어</h3>
                                    <button onClick={startWrongRetest} disabled={wrongWords.length===0} className={`px-3 py-1 text-xs font-bold rounded-full ${wrongWords.length===0 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-indigo-50 text-indigo-600'}`}>재시험</button>
                                </div>
                                {wrongPreview.length === 0 ? (
                                    <p className="text-sm text-slate-400">최근에 틀린 단어가 없습니다. 훌륭해요!</p>
                                ) : (
                                    <div className="space-y-3 max-h-72 overflow-y-auto custom-scrollbar pr-1">
                                        {wrongPreview.map((word) => (
                                            <div key={word.id} className="border border-rose-100 rounded-2xl p-3 bg-rose-50/50">
                                                <div className="flex items-center justify-between">
                                                    <span className="font-bold text-rose-600">{word.term}</span>
                                                    <span className="text-xs text-rose-400">{word.lastMissed}</span>
                                                </div>
                                                <p className="text-sm text-slate-500">{word.definition || '뜻 없음'}</p>
                                                {word.userWrongAnswer && <p className="text-xs text-slate-400 mt-1">내 답: {word.userWrongAnswer}</p>}
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <div className="mt-6 flex flex-wrap gap-3">
                                    <button onClick={()=>setMode('wrong_review')} className="px-4 py-2 bg-white border border-slate-200 text-sm font-bold rounded-xl">틀린 단어 관리</button>
                                </div>
                            </div>
                        </section>

                        <section className="bg-white rounded-3xl border border-slate-100 p-6 shadow-sm">
                            <div className="flex flex-wrap gap-3 items-center mb-4">
                                <h3 className="text-lg font-bold text-slate-800 flex-1">데이터 관리</h3>
                            </div>
                            <div className="flex flex-wrap gap-3">
                                <button onClick={seedData} className="px-4 py-2 bg-slate-100 text-sm font-semibold rounded-xl hover:bg-slate-200">샘플 100단어 추가</button>
                                <button onClick={handleGitHubSeed} className="px-4 py-2 bg-slate-100 text-sm font-semibold rounded-xl hover:bg-slate-200">GitHub CSV 불러오기</button>
                                <button onClick={()=>fileInputRef.current?.click()} className="px-4 py-2 bg-slate-100 text-sm font-semibold rounded-xl hover:bg-slate-200 flex items-center gap-2"><UploadCloud size={14}/>파일 업로드</button>
                                <button onClick={clearData} className="px-4 py-2 bg-rose-100 text-rose-600 text-sm font-semibold rounded-xl hover:bg-rose-200">전체 삭제</button>
                            </div>
                        </section>
                    </div>
                );
            };

            const renderStudyView = () => (
                <div className="max-w-4xl mx-auto px-4 pt-16 pb-10 space-y-6">
                    <div className="flex flex-wrap items-center justify-between gap-3">
                        <button onClick={() => { setIsActive(false); setMode('dashboard'); }} className="px-4 py-2 text-sm font-bold text-slate-500 bg-white border border-slate-200 rounded-full flex items-center gap-1"><ChevronLeft size={16}/>대시보드</button>
                        <div className="flex items-center gap-3 text-sm font-semibold text-slate-500">
                            <span className="px-3 py-1 bg-slate-100 rounded-full">학습 모드</span>
                            <span className="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-full">남은 시간 {formatTime(timeLeft)}</span>
                        </div>
                    </div>
                    <div className="bg-white border border-slate-100 rounded-3xl p-6 space-y-6">
                        <div className="flex flex-wrap gap-3">
                            <button onClick={()=>setHideTerm(prev=>!prev)} className={`px-3 py-1 text-xs font-bold rounded-full border ${hideTerm ? 'bg-indigo-600 text-white border-indigo-600' : 'border-slate-200 text-slate-500'}`}>{hideTerm ? '단어 보기' : '단어 숨기기'}</button>
                            <button onClick={()=>setHideDef(prev=>!prev)} className={`px-3 py-1 text-xs font-bold rounded-full border ${hideDef ? 'bg-indigo-600 text-white border-indigo-600' : 'border-slate-200 text-slate-500'}`}>{hideDef ? '뜻 보기' : '뜻 숨기기'}</button>
                            <button onClick={startTest} className="px-4 py-1 text-xs font-bold rounded-full bg-indigo-600 text-white">시험 시작</button>
                        </div>
                        {currentTestWords.length === 0 ? (
                            <div className="text-center text-slate-400 py-20">학습할 단어를 선택하세요.</div>
                        ) : (
                            <div className="space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                                {currentTestWords.map((word, index) => (
                                    <div key={word.id || index} className="border border-slate-100 rounded-2xl p-4 bg-slate-50">
                                        {!hideTerm && <p className="text-sm text-slate-400 font-semibold uppercase">#{index + 1}</p>}
                                        {!hideTerm && <h4 className="text-xl font-bold text-slate-800">{word.term}</h4>}
                                        {!hideDef && <p className="text-sm text-slate-500 mt-2">{word.definition || '뜻 없음'}</p>}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );

            const renderTestView = () => (
                <div className="max-w-4xl mx-auto px-4 pt-16 pb-10 space-y-6">
                    <div className="flex items-center justify-between gap-3 flex-wrap">
                        <button onClick={() => { setIsActive(false); setMode('dashboard'); }} className="px-4 py-2 text-sm font-bold text-slate-500 bg-white border border-slate-200 rounded-full flex items-center gap-1"><ChevronLeft size={16}/>대시보드</button>
                        <div className="flex items-center gap-3 text-sm font-semibold text-slate-500">
                            <span className="px-3 py-1 bg-rose-50 text-rose-600 rounded-full">시험 모드</span>
                            <span className="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-full">남은 시간 {formatTime(timeLeft)}</span>
                        </div>
                    </div>
                    <form onSubmit={submitTest} className="bg-white border border-slate-100 rounded-3xl p-6 space-y-4">
                        {currentTestWords.length === 0 ? (
                            <div className="text-center text-slate-400 py-20">시험에 포함된 단어가 없습니다.</div>
                        ) : (
                            currentTestWords.map((word, index) => (
                                <div key={word.id || index} className="border border-slate-100 rounded-2xl p-4">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-xs text-slate-400 font-semibold uppercase">#{index + 1}</p>
                                            <h4 className="text-lg font-bold text-slate-800">{word.term}</h4>
                                        </div>
                                        <span className="text-xs text-slate-400">{word.level || '??'}</span>
                                    </div>
                                    <textarea value={userAnswers[word.id] || ''} onChange={(e)=>handleAnswerChange(word.id, e.target.value)} className="mt-3 w-full border border-slate-200 rounded-xl p-3 text-sm text-slate-600 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-300" rows="2" placeholder="뜻을 입력하세요"></textarea>
                                </div>
                            ))
                        )}
                        <div className="flex justify-end gap-3 pt-4">
                            <button type="button" onClick={()=>{ setMode('study'); setIsActive(false); }} className="px-4 py-2 text-sm font-bold text-slate-500 bg-slate-100 rounded-xl">돌아가기</button>
                            <button type="submit" className="px-6 py-2 text-sm font-bold bg-indigo-600 text-white rounded-xl">제출하기</button>
                        </div>
                    </form>
                </div>
            );

            const renderResultView = () => {
                const total = currentTestWords.length || 1;
                const percent = Math.round((score / total) * 100);
                return (
                    <div className="max-w-4xl mx-auto px-4 pt-16 pb-10 space-y-6">
                        <div className="bg-white border border-slate-100 rounded-3xl p-6 text-center shadow-sm space-y-3">
                            <p className="text-xs font-bold uppercase text-slate-400">시험 결과</p>
                            <h2 className="text-4xl font-black text-slate-800">{score}/{total}</h2>
                            <p className="text-sm text-slate-500">정답률 {percent}%</p>
                            <div className="flex justify-center gap-3 pt-2 flex-wrap">
                                <button onClick={startWrongRetest} className="px-4 py-2 text-sm font-bold bg-white border border-slate-200 rounded-xl">틀린 단어 재시험</button>
                                <button onClick={()=>setMode('dashboard')} className="px-4 py-2 text-sm font-bold bg-indigo-600 text-white rounded-xl">대시보드</button>
                            </div>
                        </div>
                        <div className="bg-white border border-slate-100 rounded-3xl p-6 space-y-4">
                            {currentTestWords.map((word, index) => {
                                const res = gradedResults[word.id] || { isCorrect: false };
                                return (
                                    <div key={word.id || index} className={`rounded-2xl border p-4 ${res.isCorrect ? 'border-emerald-100 bg-emerald-50/50' : 'border-rose-100 bg-rose-50/50'}`}>
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <p className="text-xs text-slate-400 font-semibold uppercase">#{index + 1}</p>
                                                <h4 className="text-lg font-bold text-slate-800">{word.term}</h4>
                                            </div>
                                            <span className={`text-xs font-bold ${res.isCorrect ? 'text-emerald-600' : 'text-rose-600'}`}>{res.isCorrect ? '정답' : '오답'}</span>
                                        </div>
                                        <p className="text-sm text-slate-500 mt-2">정답: {word.definition || '뜻 없음'}</p>
                                        {!res.isCorrect && (
                                            <p className="text-sm text-slate-500 mt-1">내 답: {userAnswers[word.id] || '-'}</p>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            const renderWrongReviewView = () => (
                <div className="max-w-4xl mx-auto px-4 pt-16 pb-10 space-y-6">
                    <div className="flex items-center justify-between">
                        <h2 className="text-xl font-black text-slate-800">틀린 단어 관리</h2>
                        <div className="flex gap-2">
                            <button onClick={startWrongRetest} disabled={wrongWords.length===0} className={`px-4 py-2 text-sm font-bold rounded-xl ${wrongWords.length===0 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-indigo-600 text-white'}`}>재시험 시작</button>
                            <button onClick={()=>setMode('dashboard')} className="px-4 py-2 text-sm font-bold border border-slate-200 rounded-xl text-slate-600">대시보드</button>
                        </div>
                    </div>
                    <div className="bg-white border border-slate-100 rounded-3xl p-6 space-y-3 max-h-[70vh] overflow-y-auto custom-scrollbar pr-2">
                        {wrongWords.length === 0 ? (
                            <p className="text-center text-slate-400 py-10">틀린 단어가 없습니다.</p>
                        ) : (
                            wrongWords.map((word) => (
                                <div key={word.id} className="border border-slate-100 rounded-2xl p-4">
                                    <div className="flex items-center justify-between">
                                        <h4 className="text-lg font-bold text-slate-800">{word.term}</h4>
                                        <span className="text-xs text-slate-400">{word.lastMissed || ''}</span>
                                    </div>
                                    <p className="text-sm text-slate-500 mt-1">정답: {word.definition || '뜻 없음'}</p>
                                    {word.userWrongAnswer && <p className="text-sm text-slate-500 mt-1">내 답: {word.userWrongAnswer}</p>}
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );

            const DictionaryView = () => (
                <div className="max-w-3xl mx-auto px-4 pt-16 pb-10 space-y-6">
                    <div className="flex items-center justify-between">
                        <h2 className="text-xl font-black text-slate-800">빠른 사전</h2>
                        <button onClick={()=>setMode('dashboard')} className="px-4 py-2 text-sm font-bold border border-slate-200 rounded-xl text-slate-600">대시보드</button>
                    </div>
                    <div className="bg-white border border-slate-100 rounded-3xl p-6 space-y-4">
                        <div className="flex flex-col sm:flex-row gap-3">
                            <input type="text" value={searchTerm} onChange={(e)=>setSearchTerm(e.target.value)} className="flex-1 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-200 focus:border-indigo-300" placeholder="검색할 단어를 입력하세요"/>
                            <button onClick={handleSearch} className="px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl">검색</button>
                        </div>
                        {searchResult && (
                            <div className="border border-slate-100 rounded-2xl p-4 bg-slate-50">
                                <p className="text-xs text-slate-400 font-semibold uppercase">결과</p>
                                <h3 className="text-2xl font-bold text-slate-800 mt-1">{searchResult.term}</h3>
                                <p className="text-sm text-slate-500 mt-2">{searchResult.definition}</p>
                                <p className="text-xs text-slate-400 mt-1">레벨: {searchResult.level}</p>
                            </div>
                        )}
                    </div>
                </div>
            );


            // --- Render ---
            if (appError) return <div className="flex flex-col items-center justify-center h-screen text-center p-4"><AlertCircle className="text-red-500 mb-4" size={48} /><p className="text-slate-500 mb-6 max-w-md">{appError}</p><button onClick={()=>window.location.reload()} className="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold">새로고침</button></div>;

            // Safe check for LoginView
            if (mode === 'login') {
                 return <LoginView setMode={setMode} />;
            }

            if (mode === 'loading') {
                // Fallback logic: if auth is missing but no error, show login
                if (!auth && !appError) {
                    // setMode('login'); // Cannot update state during render, handled in useEffect
                    return <div className="flex items-center justify-center h-screen text-slate-400">초기화 중...</div>; 
                }
                return <div className="flex items-center justify-center h-screen text-slate-400">Loading...</div>;
            }

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-10">
                    {/* 상단바: 로그인 정보 및 로그아웃 버튼 */}
                    {mode === 'dashboard' && user && (
                        <div className="absolute top-4 right-4 z-50 flex items-center gap-3">
                            {/* ★ 여기에 로그인 정보가 표시됩니다 ★ */}
                            <div className="hidden sm:flex flex-col items-end mr-1">
                                <span className="text-[10px] text-slate-400 font-bold">Logged in as</span>
                                <span className="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">{user.email}</span>
                            </div>
                            <button onClick={handleSignOut} className="flex items-center gap-1 bg-white px-3 py-2 rounded-full shadow-sm border border-slate-200 text-slate-500 hover:text-red-600 hover:bg-red-50 transition-colors">
                                <LogOut size={16}/>
                                <span className="text-xs font-bold">로그아웃</span>
                            </button>
                        </div>
                    )}
                    {mode === 'dashboard' && DashboardView()}
                    {mode === 'study' && renderStudyView()}
                    {mode === 'test' && renderTestView()}
                    {mode === 'result' && renderResultView()}
                    {mode === 'wrong_review' && renderWrongReviewView()}
                    {mode === 'dictionary' && DictionaryView()}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>



